import TelegramBot from 'node-telegram-bot-api';
import gpt from './gpt.js';

// –ó–∞–º–µ–Ω–∏—Ç–µ 'YOUR_TELEGRAM_BOT_TOKEN' –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
const token = '1132532677:AAFfiv5zVD1MIsXXsHAAzlJSgl5nR9PvMwQ';

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new TelegramBot(token, { polling: true });

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
  const options = {
    reply_markup: {
      inline_keyboard: [
        [
          { text: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–∞–≤ –ø—Ä–æ–¥—É–∫—Ç–∞", callback_data: "check_composition" },
          { text: "–ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é", callback_data: "get_nutrition_tips" }
        ]
      ]
    }
  };

  bot.sendMessage(msg.chat.id, `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π!

üçã  –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –º—ã –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è, –Ω–æ —Ä–µ–¥–∫–æ –∑–∞–¥—É–º—ã–≤–∞–µ–º—Å—è –æ —Ç–æ–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–∞–≤–µ. –ö –±–æ–ª—å—à–æ–º—É —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∏—â–µ–≤—ã–µ –¥–æ–±–∞–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ–∫–∞–∑–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–º. –ò —ç—Ç–∏—Ö –¥–æ–±–∞–≤–æ–∫ —Ç–∞–∫ –º–Ω–æ–≥–æ, —á—Ç–æ –Ω–∏ –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ –Ω–µ –∑–∞–ø–æ–º–Ω–∏—Ç –∏—Ö –≤—Å–µ, –∞ –∏–∑—É—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –∏–∑ –Ω–∏—Ö –≤ —Å–æ—Å—Ç–∞–≤–µ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ù–æ –º—ã —Å –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–∏–¥—É–º–∞–ª–∏ —Ä–µ—à–µ–Ω–∏–µ!

üì±–ò—Å–ø–æ–ª—å–∑—É–π –Ω–∞—à—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É! 
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å —Å–æ—Å—Ç–∞–≤, –Ω–∞–∂–º–∏ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É, –æ—Ç–ø—Ä–∞–≤—å —á—ë—Ç–∫—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ (–ª–∏–±–æ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º), –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ–¥—ë—Ç —Ñ–æ—Ç–æ –≤ —Ç–µ–∫—Å—Ç –∏ –¥–∞—Å—Ç —Ç–µ–±–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ç–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–º. –ù–µ—Ç –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ü–∏—é –≤ –º–∞–≥–∞–∑–∏–Ω–µ.

üí°–¢–∞–∫–∂–µ –º–æ–∂–µ—à—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—á–µ—à—å —Å—Ç–∞—Ç—å –ª—É—á—à–µ. –ê –Ω–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–∞—Å—Ç —Ç–µ–±–µ —á—ë—Ç–∫–∏–µ —à–∞–≥–∏ –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —Ü–µ–ª–∏`, options);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
bot.on('callback_query', (callbackQuery) => {
  const chatId = callbackQuery.message.chat.id;
  const data = callbackQuery.data;

  if (data === 'check_composition') {
    bot.sendMessage(chatId, '–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–æ—Å—Ç–∞–≤ –ø—Ä–æ–¥—É–∫—Ç–∞, –∏ —è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞—Ö, –≤—ã–∑—ã–≤–∞—é—â–∏—Ö —Å–æ–º–Ω–µ–Ω–∏–µ.');
    bot.on('message', async (msg) => {
      const chatId = msg.chat.id;

      if (msg.text !== '/start') {

        // –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Å–æ–ª—å
        const response = await gpt('', msg.text)
        console.log(response)
        bot.sendMessage(chatId, response.content);
      } else if (msg.photo) {
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∏–±–æ–ª—å—à–µ–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        console.log(msg.photo)
        const photo = msg.photo[msg.photo.length - 1];
        const fileId = photo.file_id;

        // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª
        const file = await bot.getFile(fileId);
        const fileUrl = `https://api.telegram.org/file/bot${token}/${file.file_path}`;

        console.log(fileUrl)

        const response = await gpt(fileUrl)
        console.log(response)
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Ç—É –≥–ø—Ç

        // –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç –æ—Ç –≥–ø—Ç
        bot.sendMessage(chatId, response.content);
      }
    });
  } else if (data === 'get_nutrition_tips') {
    bot.sendMessage(chatId, `–ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é üçè –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—á–µ—à—å —Å—Ç–∞—Ç—å –ª—É—á—à–µ üåü. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ. –ù–∞–ø—Ä–∏–º–µ—Ä: 
1) –•–æ—á—É –º–µ–Ω—å—à–µ —É—Å—Ç–∞–≤–∞—Ç—å –∏ –Ω–µ –±–æ–ª–µ—Ç—å
2) –•–æ—á—É –¥–µ—Ä–∂–∞—Ç—å —Å–≤–æ–µ —Ç–µ–ª–æ –≤ —Ö–æ—Ä–æ—à–µ–π —Ñ–æ—Ä–º–µ
3) –•–æ—á—É –±—ã—Ç—å –±–æ–ª–µ–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º`);
    bot.on('message', async (msg) => {
      const chatId = msg.chat.id;

      if (msg.text !== '/start') {
        // –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Å–æ–ª—å
        const response = await gpt('', msg.text)
        console.log(response)
        bot.sendMessage(chatId, response.content);
      }
    });
  }
});


console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...');